#!/bin/bash
set -e

echo "üõ†Ô∏è  Starting system setup..."

# Install Homebrew if not already installed
if ! command -v brew &>/dev/null; then
  echo "üç∫ Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
  echo "üç∫ Homebrew already installed."
fi

echo "üç∫ Installing core packages with Homebrew..."
brew install git gh asdf curl uv

# Add ASDF to shell if not already there
# We'll source the final .zshrc later, which should contain this.
# if ! grep -q 'asdf.sh' ~/.zshrc; then
#   echo "‚öôÔ∏è  Adding ASDF to your shell config..."
#   echo -e '\\n. $(brew --prefix asdf)/libexec/asdf.sh' >> ~/.zshrc
# fi

echo "üì¶ Setting up ASDF..."
# Temporarily source asdf for this script session
. "$(brew --prefix asdf)/libexec/asdf.sh" || echo "Failed to source ASDF for init script, continuing..."

asdf plugin add python || echo "‚úÖ Python plugin already added"
asdf plugin add nodejs || echo "‚úÖ NodeJS plugin already added"
asdf plugin add poetry || echo "‚úÖ Poetry plugin already added"
asdf install || echo "‚ö†Ô∏è  ASDF install command finished (check output for errors)."

# Install Oh My Zsh (if not present)
# It creates a default ~/.zshrc which we'll overwrite next.
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  echo "üé© Installing Oh My Zsh..."
  # Run non-interactively, don't try to change shell
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
else
  echo "üé© Oh My Zsh already installed."
fi

# Run dotfiles linking script (which now forces overwrite)
echo "üîó Linking dotfiles with Dotbot..."
./link-dotfiles.sh # Use the renamed script

# Reload zsh config to apply changes including ASDF path
echo "üîÑ Reloading Zsh configuration..."
source ~/.zshrc || echo "‚ö†Ô∏è  Could not source ~/.zshrc. Please restart your terminal."

echo "‚úÖ Setup complete! Please restart your terminal for all changes to take effect."

echo -e "\n\n‚ö†Ô∏è IMPORTANT GIT SIGNING SETUP ‚ö†Ô∏è"
echo "---------------------------------------------------------------------"
echo "Your Git configuration is set up to sign commits using SSH via 1Password."
echo "To complete this setup, you MUST create or verify the file ~/.gitconfig.local"
echo "with your specific SSH signing key."
echo ""
echo "üëâ Please see the 'IMPORTANT: Setting Up Git Commit Signing' section in"
echo "   dev-setup.md for detailed step-by-step instructions."
echo "---------------------------------------------------------------------\n"
